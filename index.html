<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>雨量グラフダッシュボード</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    }
    h2, h3 {
      text-align: center;
      margin-bottom: 20px;
    }
    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-bottom: 20px;
      justify-content: center;
    }
    .controls label, .controls select, .controls input, .controls button {
      font-size: 16px;
    }
    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
      overflow-x: auto;
    }
    canvas {
      display: block;
    }
    #imageList li {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    #imageList img {
      height: 80px;
      margin-right: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #imageList button {
      margin-left: auto;
      padding: 6px 12px;
      font-size: 14px;
      cursor: pointer;
      border: none;
      background-color: #4a90e2;
      color: white;
      border-radius: 4px;
    }
    #imageList button:hover {
      background-color: #357ABD;
    }
    #imageList button.delete {
      background-color: #e74c3c;
      margin-left: 10px;
    }
    #imageList button.delete:hover {
      background-color: #c0392b;
    }
    #shareUrlContainer {
      margin-top: 10px;
      word-break: break-all;
      background: #f0f0f0;
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      user-select: all;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>雨量グラフダッシュボード</h2>
    <div class="controls">
      <div>
        <label for="startDate">開始日時:</label>
        <input type="datetime-local" id="startDate">
      </div>
      <div>
        <label for="endDate">終了日時:</label>
        <input type="datetime-local" id="endDate">
      </div>
      <div>
        <label for="chartType">グラフタイプ:</label>
        <select id="chartType">
          <option value="bar">棒グラフ</option>
          <option value="line">折れ線グラフ</option>
        </select>
      </div>
      <div>
        <label for="mode">表示モード:</label>
        <select id="mode">
          <option value="minute">X分単位</option>
          <option value="hour">X時間単位</option>
          <option value="day">X日単位</option>
          <option value="month">X月単位</option>
          <option value="year">X年単位</option>
        </select>
      </div>
      <div>
        <label for="xValue">Xの値:</label>
        <input type="number" id="xValue" min="0.1" step="0.1" value="1">
      </div>
      <div>
        <label for="labelInterval">ラベル間隔:</label>
        <input type="number" id="labelInterval" min="0" value="1">
      </div>
      <button id="loadBtn">表示</button>
      <button id="saveImageBtn">画像を保存</button>
      <button id="downloadAllBtn">一括ダウンロード</button>
      <button id="shareBtn">グラフを共有</button>
    </div>
    <div class="chart-container">
      <canvas id="rainChart"></canvas>
    </div>

    <div id="shareUrlContainer"></div>

    <h3>保存された画像リスト</h3>
    <ul id="imageList"></ul>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
    import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAk83akfuAaFBAEG3g84F7tGvcs4NBCj44",
      authDomain: "rain-9cd2b.firebaseapp.com",
      databaseURL: "https://rain-9cd2b-default-rtdb.firebaseio.com",
      projectId: "rain-9cd2b",
      storageBucket: "rain-9cd2b.appspot.com",
      messagingSenderId: "1029512490984",
      appId: "1:1029512490984:web:e9c0efd766183a449ffe5d",
      measurementId: "G-P5M8FSQ0PS"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let chart;
    const savedImages = [];

    function pad(n, size = 2) {
      return n.toString().padStart(size, '0');
    }

    function truncateDate(mode, d, x) {
      const date = new Date(d);
      if (mode === "minute") {
        const min = date.getHours() * 60 + date.getMinutes();
        const floored = Math.floor(min / x) * x;
        date.setHours(Math.floor(floored / 60), floored % 60, 0, 0);
      } else if (mode === "hour") {
        const h = Math.floor(date.getHours() / x) * x;
        date.setHours(h, 0, 0, 0);
      } else if (mode === "day") {
        const d0 = Math.floor((date.getDate() - 1) / x) * x + 1;
        date.setDate(d0); date.setHours(0,0,0,0);
      } else if (mode === "month") {
        const m = Math.floor(date.getMonth() / x) * x;
        date.setMonth(m, 1); date.setHours(0,0,0,0);
      } else if (mode === "year") {
        const y = Math.floor(date.getFullYear() / x) * x;
        date.setFullYear(y, 0, 1); date.setHours(0,0,0,0);
      }
      return date;
    }

    async function fetchData(mode, startStr, endStr, xValue) {
      const snapshot = await get(child(ref(db), 'rain'));
      const rainData = snapshot.exists() ? snapshot.val() : {};
      const dataMap = rainData[mode] || {};

      let start = truncateDate(mode, new Date(startStr), xValue);
      let end = new Date(endStr);

      const unit = { minute: 60000, hour: 3600000, day: 86400000, month: 2629800000, year: 31556952000 }[mode];
      const step = unit * xValue;

      const base = [];
      for (let t = start.getTime(); t <= end.getTime(); t += step) base.push(t);

      const sumMap = new Map();
      for (const [k, val] of Object.entries(dataMap)) {
        let d;
        if (mode === "minute") d = new Date(k.slice(0,4), k.slice(4,6)-1, k.slice(6,8), k.slice(8,10), k.slice(10,12));
        else if (mode === "hour") d = new Date(k.slice(0,4), k.slice(4,6)-1, k.slice(6,8), k.slice(8,10));
        else if (mode === "day") d = new Date(k.slice(0,4), k.slice(4,6)-1, k.slice(6,8));
        else if (mode === "month") d = new Date(k.slice(0,4), k.slice(4,6)-1, 1);
        else if (mode === "year") d = new Date(k.slice(0,4), 0, 1);
        const t = truncateDate(mode, d, xValue).getTime();
        sumMap.set(t, (sumMap.get(t) || 0) + val);
      }

      const labels = [], values = [];
      for (let t of base) {
        labels.push(makeLabel(mode, new Date(t)));
        values.push(sumMap.get(t) || 0);
      }

      return { labels, values };
    }

    function makeLabel(mode, d) {
      const y = d.getFullYear(), mo = pad(d.getMonth()+1), da = pad(d.getDate()), h = pad(d.getHours()), mi = pad(d.getMinutes());
      if (mode === "minute") return `${y}-${mo}-${da} ${h}:${mi}`;
      if (mode === "hour") return `${y}-${mo}-${da} ${h}:00`;
      if (mode === "day") return `${y}-${mo}-${da}`;
      if (mode === "month") return `${y}-${mo}`;
      if (mode === "year") return `${y}`;
    }

    function adjustCanvasWidth(labelCount) {
      const canvas = document.getElementById("rainChart");
      const width = Math.max(labelCount * 5, 600);
      canvas.style.width = `${width}px`;
      canvas.width = width;
    }

    function drawChart(labels, data, type, interval) {
      const ctx = document.getElementById("rainChart").getContext("2d");
      if (chart) chart.destroy();
      chart = new Chart(ctx, {
        type,
        data: {
          labels,
          datasets: [{
            label: '降水量 (mm)',
            data,
            backgroundColor: 'rgba(54, 162, 235, 0.6)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            fill: type === 'line'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              ticks: {
                maxRotation: 45,
                autoSkip: interval > 0,
                maxTicksLimit: interval > 0 ? Math.ceil(labels.length / interval) : undefined,
                callback: function(val, index) {
                  if (interval === 0) return this.getLabelForValue(val);
                  return index % interval === 0 ? this.getLabelForValue(val) : "";
                }
              }
            },
            y: {
              beginAtZero: true
            }
          }
        }
      });
    }

    // 画像保存＆リスト管理
    function updateImageList() {
      const list = document.getElementById("imageList");
      list.innerHTML = "";

      savedImages.forEach((img, i) => {
        const li = document.createElement("li");

        const thumb = document.createElement("img");
        thumb.src = img.data;
        thumb.alt = img.name;

        const nameSpan = document.createElement("span");
        nameSpan.textContent = img.name;
        nameSpan.style.marginRight = "10px";

        const downloadBtn = document.createElement("button");
        downloadBtn.textContent = "この画像を保存";
        downloadBtn.onclick = () => {
          const a = document.createElement("a");
          a.href = img.data;
          a.download = img.name;
          a.click();
        };

        const deleteBtn = document.createElement("button");
        deleteBtn.textContent = "削除";
        deleteBtn.classList.add("delete");
        deleteBtn.onclick = () => {
          if (confirm("この画像を削除してもよろしいですか？")) {
            savedImages.splice(i, 1);
            updateImageList();
          }
        };

        li.appendChild(thumb);
        li.appendChild(nameSpan);
        li.appendChild(downloadBtn);
        li.appendChild(deleteBtn);

        list.appendChild(li);
      });
    }

    // 共有ボタン
    document.getElementById("shareBtn").addEventListener("click", () => {
      const start = encodeURIComponent(document.getElementById("startDate").value);
      const end = encodeURIComponent(document.getElementById("endDate").value);
      const chartType = encodeURIComponent(document.getElementById("chartType").value);
      const mode = encodeURIComponent(document.getElementById("mode").value);
      const xValue = encodeURIComponent(document.getElementById("xValue").value);
      const labelInterval = encodeURIComponent(document.getElementById("labelInterval").value);

      const baseUrl = window.location.origin + window.location.pathname;
      const shareUrl = `${baseUrl}?start=${start}&end=${end}&chartType=${chartType}&mode=${mode}&xValue=${xValue}&labelInterval=${labelInterval}`;

      const container = document.getElementById("shareUrlContainer");
      container.textContent = shareUrl;

      navigator.clipboard.writeText(shareUrl)
        .then(() => alert("共有URLをクリップボードにコピーしました！"))
        .catch(() => alert("クリップボードへのコピーに失敗しました。URLを手動でコピーしてください。"));
    });

    // イメージ保存ボタン
    document.getElementById("saveImageBtn").addEventListener("click", () => {
      const canvas = document.getElementById("rainChart");
      if (!canvas) return alert("グラフがありません。");
      const imageData = canvas.toDataURL("image/png");
      const timestamp = new Date().toISOString().replace(/[:.]/g, "-");
      const name = `rain_${timestamp}.png`;

      savedImages.push({ name, data: imageData });
      updateImageList();
      alert("画像を保存しました！");
    });

    // 一括ダウンロードボタン
    document.getElementById("downloadAllBtn").addEventListener("click", async () => {
      if (savedImages.length === 0) {
        alert("保存された画像がありません。");
        return;
      }
      const zip = new JSZip();
      savedImages.forEach((img) => {
        const base64 = img.data.split(',')[1];
        zip.file(img.name, base64, { base64: true });
      });
      const content = await zip.generateAsync({ type: "blob" });
      const a = document.createElement("a");
      a.href = URL.createObjectURL(content);
      a.download = "rain_images.zip";
      a.click();
    });

    document.getElementById("loadBtn").addEventListener("click", async () => {
      const start = document.getElementById("startDate").value;
      const end = document.getElementById("endDate").value;
      const chartType = document.getElementById("chartType").value;
      const mode = document.getElementById("mode").value;
      const xValue = parseFloat(document.getElementById("xValue").value);
      const labelInterval = parseInt(document.getElementById("labelInterval").value);

      if (!start || !end || isNaN(xValue) || xValue <= 0 || isNaN(labelInterval) || labelInterval < 0) {
        alert("日付、Xの値、ラベル間隔を正しく指定してください。");
        return;
      }

      try {
        const data = await fetchData(mode, start, end, xValue);
        adjustCanvasWidth(data.labels.length);
        drawChart(data.labels, data.values, chartType, labelInterval);
      } catch (err) {
        console.error(err);
        alert("データの取得または処理でエラーが発生しました。");
      }
    });

    window.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);

      if(params.has('start')) document.getElementById("startDate").value = params.get('start');
      else {
        const now = new Date();
        const weekAgo = new Date(now.getTime() - 7*86400000);
        document.getElementById("startDate").value = weekAgo.toISOString().slice(0,16);
      }

      if(params.has('end')) document.getElementById("endDate").value = params.get('end');
      else document.getElementById("endDate").value = new Date().toISOString().slice(0,16);

      if(params.has('chartType')) document.getElementById("chartType").value = params.get('chartType');
      if(params.has('mode')) document.getElementById("mode").value = params.get('mode');
      if(params.has('xValue')) document.getElementById("xValue").value = params.get('xValue');
      if(params.has('labelInterval')) document.getElementById("labelInterval").value = params.get('labelInterval');

      if(params.has('start') && params.has('end')) {
        document.getElementById("loadBtn").click();
      }
    });
  </script>
</body>
</html>
